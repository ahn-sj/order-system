# 주문 시스템 - 제품 요구사항 명세서 (PRD)

## 1. 개요
주문 처리 과정에서 **데이터 저장(DB)** 과 **이벤트 발행(Kafka)** 간의 불일치 문제를 방지하고,  
같은 주문에 대한 이벤트 순서와 멱등성을 보장하기 위해 **Outbox 패턴**을 적용합니다.

---

## 2. 목표
- DB 트랜잭션과 이벤트 발행의 **원자성(Atomicity)** 보장
- 같은 주문 ID 내에서의 **순서 보장(Ordering)**
- 이벤트 중복 발행 시 **멱등성(Idempotency)** 처리
- 장애나 재시작 상황에서도 이벤트 **유실 방지**
- 재시도 후 반복 실패 시 **격리 상태**로 전환

> **제외 항목**
> - Kafka 브로커 장애 대응 (클러스터 재구성, 브로커 교체 등)
> - 네트워크 지연 및 패킷 손실 시 재전송·타임아웃 전략
>   - ACK 지연, 패킷 손실, 세션 타임아웃 등 네트워크 레벨 이슈에 대한 Kafka Producer/Consumer 설정은 제외
>   - **유스케이스**
>     - 트래픽이 많아져 네트워크 RTT가 길어질 때
>     - 대용량 메시지로 브로커 ACK가 지연될 때
>     - 다중 AZ/리전 환경에서 네트워크 홉이 길어질 때
>     - 브로커 ISR(복제본) 수가 많아져 ACK 대기 시간이 증가할 때
> - QUARANTINED 상태 이벤트의 재처리, 폐기, 수정 등 운영자 개입 프로세스
> - 다중 인스턴스 환경에서의 중복 발행 방지 전략 (DB 락, 분산 락, 파티션 락 등)

---

## 3. Outbox 상태 정의

| 상태값        | 설명 |
|---------------|------|
| `PENDING`     | 생성되었으나 아직 발행되지 않은 상태 |
| `COMPLETED`   | Kafka 발행 완료 |
| `QUARANTINED` | 반복 실패로 격리된 상태 |

---

## 4. 처리 흐름

### 4.1 주문 생성
- 주문 데이터와 발행 예정 이벤트를 **동일 트랜잭션**으로 저장
- 이벤트는 Outbox 테이블에 `PENDING` 상태로 기록

### 4.2 이벤트 발행
- 발행 모듈이 주기적으로 Outbox를 조회하여 Kafka 발행
- 발행 성공 시 상태를 `COMPLETED`로 변경
- 실패 시 재시도 정책 적용
- 재시도 횟수 초과 시 상태를 `QUARANTINED`로 변경

---

## 5. 특수 상황 유스케이스

### 5.1 외부 결제사 API 장애
1. 주문 생성 → Outbox 기록(`PENDING`)
2. 발행 실패 반복(재시도 3회 이상) → 상태 `QUARANTINED`

### 5.2 데이터 무결성 문제
1. 주문 생성 → 직렬화 실패 → 상태 `QUARANTINED`

---

## 6. 순서 보장 & 멱등성

### 6.1 순서 보장
- Kafka 파티션 키 = 주문 ID
- 동일 주문 ID의 이벤트는 순서 보장

### 6.2 멱등성
- 이벤트 ID(UUID)로 처리 이력 저장 (DB 또는 캐시)
- 이미 처리된 이벤트는 무시

---

## 7. 재시도 정책
- 간격: 1s → 2s → 4s → 8s → 16s → 32s
- 최대 6회 시도 후 상태를 `QUARANTINED`로 변경

---

## 8. 기술 요구사항

| 구분 | 요구사항 |
|------|----------|
| 언어/프레임워크 | Java + Spring Boot |
| 메시지 브로커 | Apache Kafka |
| DB | MySQL |
| 장애 대응 | Outbox Polling + 재시도 + 격리 처리 |
| 파티션 전략 | 주문 ID 기반 |

---

## 9. 성공 지표 (SLA)
- 이벤트 유실률: **0%**
- 이벤트 순서 오류 발생률: **0%**
- 평균 이벤트 발행 지연: **3초 이내**
- 전체 주문 처리 시간(생성 → 발행 → 소비 완료): **1분 이내**

---

## 10. 예시 시나리오

### 10.1 정상 흐름
1. 주문 생성 → Outbox(`PENDING`) → 발행 → 상태 `COMPLETED`

### 10.2 격리 상태 전환
1. 주문 생성 → 발행 실패 반복(6회) → 상태 `QUARANTINED`

# 주문 시스템 - 제품 요구사항 명세서

## 1. 개요

주문 처리 과정에서 **데이터 저장(DB)** 과 **이벤트 발행(Kafka)** 간의 불일치 문제를 방지하고,  
여러 하위 시스템이 동일한 순서와 정확한 상태로 이벤트를 수신하여 처리할 수 있도록 **Outbox 패턴**을 적용합니다.

---

## 2. 목표
- DB 트랜잭션과 이벤트 발행의 **원자성(Atomicity)** 보장
- 주문 관련 이벤트의 **순서 보장(Ordering)**
- **멱등성(Idempotency)** 확보로 중복 이벤트 무시
- 장애나 재시작 상황에서도 이벤트 **유실 방지**
- 운영자가 특정 이벤트를 안전하게 **재처리(Replay)** 가능

---

## 3. 처리 흐름

### 3.1 주문 생성
- 주문 데이터와 발행 예정 이벤트를 **동일 트랜잭션**으로 저장
- 이벤트는 `outbox` 전용 테이블에 기록 (상태: PENDING)

### 3.2 이벤트 발행
- 발행 모듈(Producer)이 주기적으로 Outbox를 읽어 Kafka로 발행
- 발행 성공 시 상태를 `COMPLETED`로 변경
- 실패 시 **지수 백오프(Exponential Backoff)** 기반 재시도

### 3.3 소비자 처리
- Kafka Consumer는 **주문 ID 기반 파티셔닝**으로 순서 보장
- 이벤트 고유 ID로 **중복 처리 방지**
- 비즈니스 로직 처리 성공 시 오프셋 커밋

### 3.4 장애 복구
- 서버 재시작 시에도 Outbox의 미발행(PENDING) 이벤트 재처리
- 격리(Quarantine) 상태의 이벤트는 운영자 승인 후 재발행 가능

### 3.5 특수 상황
- **여러 번 연속 실패** → 격리 상태로 전환
- **리플레이(Backfill)** 기능:
  - 특정 기간·주문 ID 지정 발행
  - **Dry-run**: 실제 발행 없이 영향 범위만 확인
  - **Read-only**: 발행하되 업무 로직 미실행

---

## 4. 동작 규칙

### 4.1 순서 보장
- 같은 주문 ID의 이벤트는 생성 순서대로 처리
- Kafka 파티션 키를 주문 ID로 설정하여 **컨슈머 단 순서 보장**

- 
### 4.2 중복 방지 (멱등성)
- 이벤트 고유 ID(UUID) 기반 처리 여부 기록
- 이미 처리된 ID는 무시

### 4.3 재시도 정책
- 발행 실패 시 재시도 간격: 1s → 2s → 4s → 8s … 최대 5분
- 최대 재시도 횟수 초과 시 격리 상태 전환

### 4.4 운영자 기능
- 격리 이벤트 재처리/폐기
- 특정 주문·기간 재발행
- Dry-run/Read-only 모드 지원

---

## 5. 기술 요구사항

| 구분 | 요구사항 |
|------|----------|
| 언어/프레임워크 | Java + Spring Boot |
| 메시지 브로커 | Apache Kafka |
| DB | MySQL/PostgreSQL (트랜잭션 지원) |
| 장애 대응 | Outbox Polling + 재시도/격리 로직 |
| 모니터링 | Kafka Lag, Outbox 상태, 재시도 횟수 대시보드 |
| 확장성 | 주문 ID 기반 파티션 확장 가능 구조 |
| 보안 | 이벤트 데이터 암호화 옵션, 접근 제어 |

---

## 6. 기대 효과
- **데이터 불일치 제거**: DB와 이벤트 발행 간 싱크 보장
- **장애 대응력 향상**: 이벤트 유실 0건 목표
- **운영 편의성**: 이벤트 재발행·격리 관리 기능 제공
- **Kafka 학습/적용**: 멱등성, 순서 보장, 재시도 메커니즘 실습 가능

---

## 7. 예시 시나리오

### 정상 흐름
1. 주문 생성 → Outbox 기록 → Kafka 발행 → 컨슈머 처리 → 오프셋 커밋

### 발행 실패
1. 주문 생성 → Outbox 기록 → Kafka 발행 실패 → 재시도 성공

### 격리 사례
1. 주문 생성 → Outbox 기록 → Kafka 발행 실패 반복 → 격리 → 운영자 재발행

### 리플레이
1. 운영자가 기간 지정 → Dry-run 확인 → 실제 재발행
